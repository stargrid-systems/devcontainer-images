name: Build and Publish Devcontainer Image

on:
  workflow_call:
    inputs:
      image:
        description: 'Image name (e.g., base, rust-avr)'
        required: true
        type: string
      version:
        description: 'Semver version (e.g., 1.2.3)'
        required: true
        type: string
      create-release:
        description: 'Create a GitHub release'
        required: false
        type: boolean
        default: true

env:
  REGISTRY: ghcr.io
  IMAGE_BASE: ${{ github.repository }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      packages: write
    
    outputs:
      image-name: ${{ steps.meta.outputs.image-name }}
      major: ${{ steps.validate.outputs.major }}
      minor: ${{ steps.validate.outputs.minor }}
      patch: ${{ steps.validate.outputs.patch }}
      major-minor: ${{ steps.validate.outputs.major-minor }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Validate version format
        id: validate
        run: |
          VERSION="${{ inputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in semver format (e.g., 1.2.3)"
            exit 1
          fi
          
          # Parse semver components
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          PATCH=$(echo "$VERSION" | cut -d. -f3)
          
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT
          echo "patch=$PATCH" >> $GITHUB_OUTPUT
          echo "major-minor=$MAJOR.$MINOR" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Extract metadata for image
        id: meta
        run: |
          IMAGE_NAME="${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}/${{ inputs.image }}"
          echo "image-name=$IMAGE_NAME" >> $GITHUB_OUTPUT

      - name: Build devcontainer image
        id: build
        uses: devcontainers/ci@8bf61b26e9c3a98f69cb6ce2f88d24ff59b785c6 # v0.3
        with:
          imageName: ${{ steps.meta.outputs.image-name }}
          imageTag: ${{ inputs.version }},${{ steps.validate.outputs.major-minor }},${{ steps.validate.outputs.major }},latest
          subFolder: src/${{ inputs.image }}
          cacheFrom: ${{ steps.meta.outputs.image-name }}:latest
          push: never

  publish:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Build and push devcontainer image
        uses: devcontainers/ci@8bf61b26e9c3a98f69cb6ce2f88d24ff59b785c6 # v0.3
        with:
          imageName: ${{ needs.build.outputs.image-name }}
          imageTag: ${{ inputs.version }},${{ needs.build.outputs.major-minor }},${{ needs.build.outputs.major }},latest
          subFolder: src/${{ inputs.image }}
          cacheFrom: ${{ needs.build.outputs.image-name }}:latest
          push: always
        env:
          BUILDKIT_PROGRESS: plain

      - name: Generate image metadata
        id: image-info
        run: |
          IMAGE_REF="${{ needs.build.outputs.image-name }}:${{ inputs.version }}"
          
          # Get image digest from pushed image in registry
          # Retry up to 5 times as the image may need time to be available in the registry
          DIGEST=""
          for i in {1..5}; do
            DIGEST=$(docker buildx imagetools inspect "$IMAGE_REF" --format '{{.Manifest.Digest}}' 2>/dev/null || true)
            if [ -n "$DIGEST" ]; then
              break
            fi
            if [ $i -lt 5 ]; then
              echo "Attempt $i failed, retrying in 5 seconds..."
              sleep 5
            fi
          done
          
          # If still not found, use a placeholder
          if [ -z "$DIGEST" ]; then
            DIGEST="unavailable-check-registry"
            echo "Warning: Could not retrieve digest from registry, image may still be processing"
          fi
          
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          
          # Get creation timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          
          echo "Image: $IMAGE_REF"
          echo "Digest: $DIGEST"

      - name: Create release notes
        if: inputs.create-release
        id: release-notes
        run: |
          cat << EOF > release-notes.md
          # ${{ inputs.image }} v${{ inputs.version }}
          
          ## Container Image
          
          \`\`\`bash
          docker pull ${{ needs.build.outputs.image-name }}:${{ inputs.version }}
          \`\`\`
          
          **Available tags:**
          - \`${{ inputs.version }}\` - Full version
          - \`${{ needs.build.outputs.major-minor }}\` - Major.Minor
          - \`${{ needs.build.outputs.major }}\` - Major only
          - \`latest\` - Latest release
          
          **Image digest:** \`${{ steps.image-info.outputs.digest }}\`
          
          **Built:** ${{ steps.image-info.outputs.timestamp }}
          
          ## Usage in devcontainer.json
          
          \`\`\`json
          {
            "image": "${{ needs.build.outputs.image-name }}:${{ inputs.version }}"
          }
          \`\`\`
          
          Or use semantic versioning for automatic updates:
          
          \`\`\`json
          {
            "image": "${{ needs.build.outputs.image-name }}:${{ needs.build.outputs.major }}"
          }
          \`\`\`
          
          ## Changes
          
          See [src/${{ inputs.image }}](https://github.com/${{ github.repository }}/tree/${{ github.sha }}/src/${{ inputs.image }}) for the image definition.
          EOF
          
          cat release-notes.md

      - name: Create GitHub Release
        if: inputs.create-release
        uses: softprops/action-gh-release@de2c0eb89ae2a093876385947365aca7b0e5f844 # v1
        with:
          tag_name: ${{ inputs.image }}/v${{ inputs.version }}
          name: ${{ inputs.image }} v${{ inputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Successfully built and published **${{ inputs.image }}** version **${{ inputs.version }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published Tags" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ needs.build.outputs.image-name }}:${{ inputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ needs.build.outputs.image-name }}:${{ needs.build.outputs.major-minor }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ needs.build.outputs.image-name }}:${{ needs.build.outputs.major }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ needs.build.outputs.image-name }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Digest" >> $GITHUB_STEP_SUMMARY
          echo "\`${{ steps.image-info.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
