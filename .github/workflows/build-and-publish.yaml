name: Build and Publish Devcontainer Image

on:
  workflow_call:
    inputs:
      image:
        description: 'Image name (e.g., base, rust-avr)'
        required: true
        type: string
      version:
        description: 'Semver version (e.g., 1.2.3)'
        required: true
        type: string
      create-release:
        description: 'Create a GitHub release'
        required: false
        type: boolean
        default: true

env:
  REGISTRY: ghcr.io
  IMAGE_BASE: ${{ github.repository }}

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate version format
        id: validate
        run: |
          VERSION="${{ inputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in semver format (e.g., 1.2.3)"
            exit 1
          fi
          
          # Parse semver components
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          PATCH=$(echo "$VERSION" | cut -d. -f3)
          
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT
          echo "patch=$PATCH" >> $GITHUB_OUTPUT
          echo "major-minor=$MAJOR.$MINOR" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for image
        id: meta
        run: |
          IMAGE_NAME="${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}/${{ inputs.image }}"
          
          # Generate all semver tags: 1, 1.2, 1.2.3
          TAGS="${IMAGE_NAME}:${{ inputs.version }}"
          TAGS="${TAGS},${IMAGE_NAME}:${{ steps.validate.outputs.major-minor }}"
          TAGS="${TAGS},${IMAGE_NAME}:${{ steps.validate.outputs.major }}"
          TAGS="${TAGS},${IMAGE_NAME}:latest"
          
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "image-name=$IMAGE_NAME" >> $GITHUB_OUTPUT
          echo "Created tags: $TAGS"

      - name: Build devcontainer image
        id: build
        uses: devcontainers/ci@v0.3
        with:
          imageName: ${{ steps.meta.outputs.image-name }}
          imageTag: ${{ inputs.version }},${{ steps.validate.outputs.major-minor }},${{ steps.validate.outputs.major }},latest
          subFolder: src/${{ inputs.image }}
          cacheFrom: ${{ steps.meta.outputs.image-name }}:latest
          push: always
          skipContainerUserIdUpdate: false
        env:
          BUILDKIT_PROGRESS: plain

      - name: Generate image metadata
        id: image-info
        run: |
          IMAGE_REF="${{ steps.meta.outputs.image-name }}:${{ inputs.version }}"
          
          # Get image digest
          DIGEST=$(docker buildx imagetools inspect "$IMAGE_REF" --format '{{.Manifest.Digest}}')
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          
          # Get creation timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          
          echo "Image: $IMAGE_REF"
          echo "Digest: $DIGEST"

      - name: Create release notes
        if: inputs.create-release
        id: release-notes
        run: |
          cat << EOF > release-notes.md
          # ${{ inputs.image }} v${{ inputs.version }}
          
          ## Container Image
          
          \`\`\`bash
          docker pull ${{ steps.meta.outputs.image-name }}:${{ inputs.version }}
          \`\`\`
          
          **Available tags:**
          - \`${{ inputs.version }}\` - Full version
          - \`${{ steps.validate.outputs.major-minor }}\` - Major.Minor
          - \`${{ steps.validate.outputs.major }}\` - Major only
          - \`latest\` - Latest release
          
          **Image digest:** \`${{ steps.image-info.outputs.digest }}\`
          
          **Built:** ${{ steps.image-info.outputs.timestamp }}
          
          ## Usage in devcontainer.json
          
          \`\`\`json
          {
            "image": "${{ steps.meta.outputs.image-name }}:${{ inputs.version }}"
          }
          \`\`\`
          
          Or use semantic versioning for automatic updates:
          
          \`\`\`json
          {
            "image": "${{ steps.meta.outputs.image-name }}:${{ steps.validate.outputs.major }}"
          }
          \`\`\`
          
          ## Changes
          
          See [src/${{ inputs.image }}](https://github.com/${{ github.repository }}/tree/${{ github.sha }}/src/${{ inputs.image }}) for the image definition.
          EOF
          
          cat release-notes.md

      - name: Create GitHub Release
        if: inputs.create-release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.image }}/v${{ inputs.version }}
          name: ${{ inputs.image }} v${{ inputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Successfully built and published **${{ inputs.image }}** version **${{ inputs.version }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published Tags" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ steps.meta.outputs.image-name }}:${{ inputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ steps.meta.outputs.image-name }}:${{ steps.validate.outputs.major-minor }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ steps.meta.outputs.image-name }}:${{ steps.validate.outputs.major }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ steps.meta.outputs.image-name }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Digest" >> $GITHUB_STEP_SUMMARY
          echo "\`${{ steps.image-info.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
